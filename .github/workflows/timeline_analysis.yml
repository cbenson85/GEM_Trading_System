name: Run Timeline Analysis on Test Set

on:
  workflow_dispatch:
    inputs:
      test_file:
        description: 'Test set file to run timeline analysis on'
        required: true
        default: 'DISCARD_EXPLOSIONS.json'
      report_file:
        description: 'Output report file name'
        required: true
        default: 'timeline_analysis_report.txt'

jobs:
  timeline-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allow the job to push the new report

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 3. Install All Dependencies
        run: |
          echo "Installing all required libraries..."
          pip install requests numpy polygon-api-client pandas

      - name: 4. Run Timeline Analyzer
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          INPUT_FILE=${{ github.event.inputs.test_file }}
          OUTPUT_FILE=${{ github.event.inputs.report_file }}

          echo "--- RUNNING TIMELINE ANALYSIS ---"
          echo "Testing model on tickers from $INPUT_FILE..."
          
          if [ ! -f "$INPUT_FILE" ]; then
            echo "‚ùå CRITICAL ERROR: Input file '$INPUT_FILE' not found!"
            exit 1
          fi

          python timeline_analyzer.py "$INPUT_FILE" "$OUTPUT_FILE"

      - name: 5. Commit and push test report
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          OUTPUT_FILE=${{ github.event.inputs.report_file }}
          
          git add "$OUTPUT_FILE"
          git status
          
          if git diff --cached --quiet; then
            echo "No changes to commit. Report is identical to the previous run."
            exit 0
          fi
          
          git commit -m "Automated Workflow: Run timeline analysis and save report ($OUTPUT_FILE) - $(date)"
          
          # Force push to avoid conflicts if the file already exists
          git push
