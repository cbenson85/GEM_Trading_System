name: Sustainability Filter Workflow (V2.0)
on:
  workflow_dispatch:  # Manual trigger
    inputs:
      reason:
        description: 'Reason for running filter'
        required: false
        default: 'Manual sustainability filter run'
      batch_size:
        description: 'Number of stocks to process (default: all 200)'
        required: false
        default: '200'

jobs:
  filter-sustainability:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour max (plenty for 5-15 min runtime)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Pre-Filter Status Check
        run: |
          echo "ðŸ“Š PRE-FILTER STATUS"
          echo "=================================="
          echo ""
          echo "Current CLEAN.json stocks:"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âš¡ ESTIMATED RUNTIME: 5-15 minutes for 200 stocks (Developer tier)"
          echo "ðŸ”¬ CRITERIA: 80% retention 21 days after peak"
          echo ""
      
      - name: Run Sustainability Filter V2.0
        run: |
          echo "ðŸ”¬ Starting Sustainability Filter V2.0..."
          echo "Input: Verified_Backtest_Data/explosive_stocks_CLEAN.json"
          echo "Output: Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json"
          echo "Criteria: 80% retention 21 days after peak"
          echo ""
          echo "âš¡ Developer Tier: Unlimited API requests!"
          echo "â±ï¸  Expected completion: 5-15 minutes"
          echo ""
          python filter_sustainability.py
        env:
          PYTHONUNBUFFERED: 1
      
      - name: Verify Filter Results
        run: |
          echo ""
          echo "=================================="
          echo "ðŸ“Š FILTER RESULTS"
          echo "=================================="
          echo ""
          echo "âœ… CLEAN.json (Sustainable Stocks):"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âŒ UNSUSTAINABLE.json (Pump & Dumps):"
          python -c "
          import json
          try:
              data = json.load(open('Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json'))
              print(f'  Total: {len(data)} stocks')
          except FileNotFoundError:
              print('  File not created (no unsustainable stocks found)')
          "
          echo ""
          echo "ðŸ“ˆ Summary Statistics:"
          cat Verified_Backtest_Data/sustainability_summary.json | python -m json.tool
          echo ""
      
      - name: Calculate Sustainability Rate
        run: |
          echo "=================================="
          echo "ðŸ“Š SUSTAINABILITY ANALYSIS"
          echo "=================================="
          python -c "
          import json
          
          # Load summary
          summary = json.load(open('Verified_Backtest_Data/sustainability_summary.json'))
          
          total = summary.get('total_stocks', 0)
          sustainable = summary.get('sustainable', 0)
          unsustainable = summary.get('unsustainable', 0)
          
          if total > 0:
              sust_rate = (sustainable / total) * 100
              unsust_rate = (unsustainable / total) * 100
              
              print(f'Total Tested: {total}')
              print(f'Sustainable: {sustainable} ({sust_rate:.1f}%)')
              print(f'Unsustainable: {unsustainable} ({unsust_rate:.1f}%)')
              print(f'')
              print(f'Criteria: {summary.get(\"criteria\", \"Unknown\")}')
          else:
              print('No stocks tested')
          "
          echo ""
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Verified_Backtest_Data/explosive_stocks_CLEAN.json
          git add Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json
          git add Verified_Backtest_Data/sustainability_summary.json
          git diff --staged --quiet || git commit -m "ðŸ”¬ Sustainability filter V2.0: Update CLEAN.json and UNSUSTAINABLE.json
          
          - Tested stocks for 21-day hold sustainability (80% retention threshold)
          - Removed unsustainable stocks from CLEAN.json
          - Archived unsustainable stocks to UNSUSTAINABLE.json
          - Generated summary statistics
          
          Filter Version: 2.0
          Criteria: 80% retention 21 days after peak
          Reason: ${{ github.event.inputs.reason }}"
          git push
      
      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "=================================="
          echo "âœ… WORKFLOW COMPLETE"
          echo "=================================="
          echo ""
          echo "Files Updated:"
          echo "  - explosive_stocks_CLEAN.json"
          echo "  - explosive_stocks_UNSUSTAINABLE.json"
          echo "  - sustainability_summary.json"
          echo ""
          echo "Next Steps:"
          echo "  1. Review sustainability_summary.json"
          echo "  2. Verify CLEAN.json contains only sustainable stocks"
          echo "  3. Proceed with Phase 3 pre-catalyst analysis"
          echo ""
