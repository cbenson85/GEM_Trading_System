name: Sustained Gain Filter V3.0
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running filter'
        required: false
        default: 'Test sustained gain window methodology'

jobs:
  filter-sustained-gain:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Pre-Filter Status Check
        run: |
          echo "ðŸ“Š PRE-FILTER STATUS"
          echo "=================================="
          echo ""
          echo "Current CLEAN.json stocks:"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âš¡ METHODOLOGY: Sustained Gain Window Test"
          echo "ðŸ”¬ CRITERIA:"
          echo "   - FAST gains (<30d to peak): 250%+ sustained minimum"
          echo "   - MEDIUM gains (30-90d): 200%+ sustained minimum"
          echo "   - SLOW gains (90+d): 150%+ sustained minimum"
          echo ""
          echo "â±ï¸  ESTIMATED RUNTIME: 10-20 minutes (Developer tier)"
          echo ""
      
      - name: Run Sustained Gain Filter V3.0
        run: |
          echo "ðŸ”¬ Starting Sustained Gain Filter V3.0..."
          echo "Input: Verified_Backtest_Data/explosive_stocks_CLEAN.json"
          echo "Output: Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json"
          echo ""
          echo "Test Method: Track minimum gain from entry to peak+60 days"
          echo "Purpose: Identify stocks with sustained elevation (not just peak timing)"
          echo ""
          python filter_sustained_gain_v3.py
        env:
          PYTHONUNBUFFERED: 1
      
      - name: Verify Filter Results
        run: |
          echo ""
          echo "=================================="
          echo "ðŸ“Š FILTER RESULTS"
          echo "=================================="
          echo ""
          echo "âœ… CLEAN.json (Sustainable Stocks):"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âŒ UNSUSTAINABLE.json (Pump & Dumps):"
          python -c "
          import json
          try:
              data = json.load(open('Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json'))
              count = len(data) if isinstance(data, list) else len(data.get('stocks', []))
              print(f'  Total: {count} stocks')
          except FileNotFoundError:
              print('  File not created (no unsustainable stocks found)')
          "
          echo ""
          echo "ðŸ“ˆ Summary Statistics:"
          cat Verified_Backtest_Data/sustained_gain_summary.json | python -m json.tool
          echo ""
      
      - name: Analyze Sustainability Rates
        run: |
          echo "=================================="
          echo "ðŸ“Š SUSTAINABILITY ANALYSIS BY SPEED"
          echo "=================================="
          python -c "
          import json
          
          summary = json.load(open('Verified_Backtest_Data/sustained_gain_summary.json'))
          
          total = summary.get('total_stocks', 0)
          sustainable = summary.get('sustainable', 0)
          unsustainable = summary.get('unsustainable', 0)
          
          if total > 0:
              print(f'')
              print(f'Overall Results:')
              print(f'  Total: {total}')
              print(f'  Sustainable: {sustainable} ({sustainable/total*100:.1f}%)')
              print(f'  Unsustainable: {unsustainable} ({unsustainable/total*100:.1f}%)')
              print(f'')
              print(f'By Speed Category:')
              
              by_speed = summary.get('by_speed', {})
              for speed in ['FAST', 'MEDIUM', 'SLOW']:
                  if speed in by_speed:
                      data = by_speed[speed]
                      speed_total = data.get('total', 0)
                      speed_sust = data.get('sustainable', 0)
                      rate = data.get('sustainability_rate', '0%')
                      print(f'  {speed:8} : {speed_sust}/{speed_total} sustainable ({rate})')
              
              print(f'')
              print(f'Filter Version: {summary.get(\"filter_version\", \"unknown\")}')
              print(f'Test Method: {summary.get(\"test_method\", \"unknown\")}')
          else:
              print('No stocks tested')
          "
          echo ""
      
      - name: Extract Position Management Insights
        run: |
          echo "=================================="
          echo "ðŸ’¡ POSITION MANAGEMENT INSIGHTS"
          echo "=================================="
          echo ""
          echo "Analyzing sustainable stocks for trading patterns..."
          python -c "
          import json
          
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          
          if len(stocks) > 0:
              print(f'Sample insights from {len(stocks)} sustainable stocks:')
              print(f'')
              
              # Analyze first few sustainable stocks
              for i, stock in enumerate(stocks[:3]):
                  test = stock.get('sustained_gain_test', {})
                  ticker = stock.get('ticker', 'UNKNOWN')
                  
                  if test:
                      print(f'{i+1}. {ticker}:')
                      print(f'   Speed: {test.get(\"speed_category\", \"unknown\")}')
                      print(f'   Min gain held: {test.get(\"min_gain_pct\", 0):.1f}%')
                      print(f'   Max drawdown: {test.get(\"drawdown_from_peak_pct\", 0):.1f}% from peak')
                      
                      pos_mgmt = test.get('position_management', {})
                      if pos_mgmt:
                          print(f'   Stop loss ref: {pos_mgmt.get(\"stop_loss_reference\", \"unknown\")}')
                      print(f'')
              
              print(f'These insights will be used for:')
              print(f'  â€¢ Setting stop losses (based on min gain levels)')
              print(f'  â€¢ Position sizing (based on speed category risk)')
              print(f'  â€¢ Exit timing (based on typical drawdown patterns)')
              print(f'  â€¢ Scaling strategies (50% at X%, hold rest for Y days)')
          else:
              print('No sustainable stocks found')
          "
          echo ""
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Verified_Backtest_Data/explosive_stocks_CLEAN.json
          git add Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json
          git add Verified_Backtest_Data/sustained_gain_summary.json
          git diff --staged --quiet || git commit -m "ðŸ”¬ Sustained Gain Filter V3.0: Test results
          
          - Tested stocks for sustained minimum gain over extended period
          - Speed-adjusted thresholds (FAST: 250%+, MEDIUM: 200%+, SLOW: 150%+)
          - Filters out pump & dumps while keeping stocks that hold through corrections
          - Updated CLEAN.json with sustainable stocks only
          - Generated position management insights
          
          Filter Method: Sustained Gain Window (entry â†’ peak+60 days)
          Reason: ${{ github.event.inputs.reason }}"
          git push
      
      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "=================================="
          echo "âœ… WORKFLOW COMPLETE"
          echo "=================================="
          echo ""
          echo "Files Updated:"
          echo "  - explosive_stocks_CLEAN.json (sustainable stocks)"
          echo "  - explosive_stocks_UNSUSTAINABLE.json (pump & dumps)"
          echo "  - sustained_gain_summary.json (statistics + insights)"
          echo ""
          echo "Key Improvements Over V2.0:"
          echo "  â€¢ Tests sustained gain, not just peak retention"
          echo "  â€¢ Speed-adjusted thresholds (fast gains need stricter test)"
          echo "  â€¢ Market corrections don't disqualify good stocks"
          echo "  â€¢ Position management insights for later use"
          echo ""
          echo "Next Steps:"
          echo "  1. Review sustained_gain_summary.json"
          echo "  2. Analyze sustainable stock characteristics"
          echo "  3. Begin Phase 3 pre-catalyst analysis"
          echo "  4. Use insights to build position management rules"
          echo ""
