name: Sustained Gain Filter V4.0
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running filter'
        required: false
        default: 'Test Total Days Above 200% methodology'

jobs:
  filter-sustained-gain:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Pre-Filter Status Check
        run: |
          echo "ðŸ“Š PRE-FILTER STATUS"
          echo "=================================="
          echo ""
          echo "Current CLEAN.json stocks:"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âš¡ METHODOLOGY: Total Days Above 200% Threshold"
          echo "ðŸ”¬ CRITERIA:"
          echo "   - Count TOTAL days above 200% gain (not consecutive)"
          echo "   - Minimum: 14 days above 200% threshold"
          echo "   - Focus: Did stock give 2+ weeks to exit with 200%+ profit?"
          echo "   - Handles: Normal volatility, multiple run-ups"
          echo "   - Filters: Pump-and-dumps (brief spikes that crash)"
          echo ""
          echo "â±ï¸  ESTIMATED RUNTIME: 10-20 minutes (Developer tier)"
          echo ""
      
      - name: Run Sustained Gain Filter V4.0
        run: |
          echo "ðŸ”¬ Starting Sustained Gain Filter V4.0..."
          echo "Input: Verified_Backtest_Data/explosive_stocks_CLEAN.json"
          echo "Output: Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json"
          echo ""
          echo "Test Method: Total Days Above 200% Threshold"
          echo "Purpose: Filter pump & dumps, keep stocks with sufficient exit window"
          echo ""
          python filter_sustainability.py
        env:
          PYTHONUNBUFFERED: 1
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      
      - name: Verify Filter Results
        run: |
          echo ""
          echo "=================================="
          echo "ðŸ“Š FILTER RESULTS"
          echo "=================================="
          echo ""
          echo "âœ… CLEAN.json (Sustainable Stocks):"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total: {len(stocks)} stocks')
          "
          echo ""
          echo "âŒ UNSUSTAINABLE.json (Pump & Dumps):"
          python -c "
          import json
          try:
              data = json.load(open('Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json'))
              count = len(data) if isinstance(data, list) else len(data.get('stocks', data))
              print(f'  Total: {count} stocks')
          except FileNotFoundError:
              print('  File not created (no unsustainable stocks found)')
          "
          echo ""
          echo "ðŸ“ˆ Summary Statistics:"
          cat Verified_Backtest_Data/sustained_gain_summary.json | python -m json.tool
          echo ""
      
      - name: Analyze Sustainability Rates
        run: |
          echo "=================================="
          echo "ðŸ“Š SUSTAINABILITY ANALYSIS"
          echo "=================================="
          python -c "
          import json
          
          summary = json.load(open('Verified_Backtest_Data/sustained_gain_summary.json'))
          
          total = summary.get('total_stocks', 0)
          sustainable = summary.get('sustainable', 0)
          unsustainable = summary.get('unsustainable', 0)
          not_tested = summary.get('not_tested', 0)
          
          if total > 0:
              print(f'')
              print(f'Overall Results:')
              print(f'  Total Stocks: {total}')
              print(f'  Sustainable: {sustainable} ({sustainable/total*100:.1f}%)')
              print(f'  Unsustainable: {unsustainable} ({unsustainable/total*100:.1f}%)')
              print(f'  Not Tested: {not_tested} ({not_tested/total*100:.1f}%)')
              print(f'')
              print(f'Key Metrics:')
              print(f'  Filter Version: {summary.get(\"filter_version\", \"unknown\")}')
              print(f'  Method: {summary.get(\"filter_method\", \"unknown\")}')
              print(f'  Min Days Required: {summary.get(\"min_days_required\", \"unknown\")}')
              print(f'  Threshold: {summary.get(\"threshold_gain_pct\", \"unknown\")}% gain')
              print(f'  API Calls: {summary.get(\"api_calls\", 0)}')
          else:
              print('No stocks tested')
          "
          echo ""
      
      - name: Extract Key Insights
        run: |
          echo "=================================="
          echo "ðŸ’¡ KEY INSIGHTS"
          echo "=================================="
          echo ""
          echo "V4.0 Improvements Over V3.0:"
          echo "  â€¢ Counts TOTAL days above 200% (not consecutive)"
          echo "  â€¢ Handles normal volatility and multiple run-ups"
          echo "  â€¢ Focus on exit window, not pattern matching"
          echo "  â€¢ Question: 'Did I have 2+ weeks to exit?'"
          echo ""
          echo "Sustainable stocks have:"
          echo "  â€¢ 14+ days above 200% gain threshold"
          echo "  â€¢ Sufficient time to notice and exit"
          echo "  â€¢ Not pump-and-dumps"
          echo ""
          echo "These stocks are ready for Phase 3 pattern discovery"
          echo ""
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Verified_Backtest_Data/explosive_stocks_CLEAN.json
          git add Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json
          git add Verified_Backtest_Data/sustained_gain_summary.json
          git diff --staged --quiet || git commit -m "ðŸ”¬ Sustained Gain Filter V4.0: Total Days Above 200% method
          
          - NEW METHOD: Counts total days (not consecutive) above 200% threshold
          - Filters pump-and-dumps (<14 days above 200%)
          - Keeps stocks with sufficient exit window (14+ days)
          - Handles normal volatility and multiple opportunities
          - Focus: 'Did stock give me 2+ weeks to exit with 200%+ profit?'
          
          Filter Method: Total Days Above 200% Threshold
          Min Days Required: 14
          Reason: ${{ github.event.inputs.reason }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "=================================="
          echo "âœ… WORKFLOW COMPLETE"
          echo "=================================="
          echo ""
          echo "Files Updated:"
          echo "  - explosive_stocks_CLEAN.json (sustainable stocks only)"
          echo "  - explosive_stocks_UNSUSTAINABLE.json (pump & dumps)"
          echo "  - sustained_gain_summary.json (statistics)"
          echo ""
          echo "Key Improvements V4.0:"
          echo "  â€¢ Total days counting (not consecutive)"
          echo "  â€¢ Handles volatility better"
          echo "  â€¢ Focus on exit window reality"
          echo "  â€¢ Removes brief spikes that crash"
          echo ""
          echo "Next Steps:"
          echo "  1. Review sustained_gain_summary.json"
          echo "  2. Verify sustainability rate (70-80% expected)"
          echo "  3. Begin Phase 3 pattern discovery"
          echo "  4. Analyze sustainable stock characteristics"
          echo ""
