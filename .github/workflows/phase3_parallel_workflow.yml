name: Phase 3 Parallel Analysis - All Data Points

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Analysis mode'
        required: true
        default: 'test'
        type: choice
        options:
          - test       # 10 stocks (5 batches Ã— 2 stocks)
          - sample     # 200 stocks (5 batches Ã— 40 stocks)
          - full       # All 694 stocks (10 batches Ã— ~70 stocks)

permissions:
  contents: write

jobs:
  # Job 0: Split stocks into batches
  prepare-batches:
    runs-on: ubuntu-latest
    outputs:
      batch_count: ${{ steps.split.outputs.batch_count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Split stocks into batches
      id: split
      run: |
        MODE="${{ github.event.inputs.mode }}"
        
        if [ "$MODE" = "test" ]; then
          echo "ðŸ“Š TEST MODE: Splitting 10 stocks into 5 batches (2 stocks each)"
          python phase3_batch_splitter.py Verified_Backtest_Data/explosive_stocks_CLEAN.json --batches 5 --test
          echo "batch_count=5" >> $GITHUB_OUTPUT
        elif [ "$MODE" = "sample" ]; then
          echo "ðŸ“Š SAMPLE MODE: Splitting 200 stocks into 5 batches (40 stocks each)"
          python phase3_batch_splitter.py Verified_Backtest_Data/explosive_stocks_CLEAN.json --batches 5 --limit 200
          echo "batch_count=5" >> $GITHUB_OUTPUT
        else
          echo "ðŸ“Š FULL MODE: Splitting all 694 stocks into 10 batches"
          python phase3_batch_splitter.py Verified_Backtest_Data/explosive_stocks_CLEAN.json --batches 10
          echo "batch_count=10" >> $GITHUB_OUTPUT
        fi
        
        # Show what was created
        echo ""
        echo "ðŸ“ Batch files created:"
        ls -lh batch_inputs/
    
    - name: Upload batch files as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
  
  # Parallel Analysis Jobs (5 concurrent for test/sample, 10 for full)
  analyze-batch-1:
    needs: prepare-batches
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 1
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 1 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch1 batch_inputs/batch1_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch1-results
        path: Verified_Backtest_Data/phase3_batch_batch1_analysis.json
  
  analyze-batch-2:
    needs: prepare-batches
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 2
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 2 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch2 batch_inputs/batch2_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch2-results
        path: Verified_Backtest_Data/phase3_batch_batch2_analysis.json
  
  analyze-batch-3:
    needs: prepare-batches
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 3
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 3 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch3 batch_inputs/batch3_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch3-results
        path: Verified_Backtest_Data/phase3_batch_batch3_analysis.json
  
  analyze-batch-4:
    needs: prepare-batches
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 4
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 4 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch4 batch_inputs/batch4_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch4-results
        path: Verified_Backtest_Data/phase3_batch_batch4_analysis.json
  
  analyze-batch-5:
    needs: prepare-batches
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 5
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 5 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch5 batch_inputs/batch5_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch5-results
        path: Verified_Backtest_Data/phase3_batch_batch5_analysis.json
  
  # Additional batches for full mode (batches 6-10)
  analyze-batch-6:
    needs: prepare-batches
    if: ${{ github.event.inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 6
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 6 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch6 batch_inputs/batch6_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch6-results
        path: Verified_Backtest_Data/phase3_batch_batch6_analysis.json
  
  analyze-batch-7:
    needs: prepare-batches
    if: ${{ github.event.inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 7
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 7 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch7 batch_inputs/batch7_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch7-results
        path: Verified_Backtest_Data/phase3_batch_batch7_analysis.json
  
  analyze-batch-8:
    needs: prepare-batches
    if: ${{ github.event.inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 8
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 8 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch8 batch_inputs/batch8_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch8-results
        path: Verified_Backtest_Data/phase3_batch_batch8_analysis.json
  
  analyze-batch-9:
    needs: prepare-batches
    if: ${{ github.event.inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 9
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 9 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch9 batch_inputs/batch9_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch9-results
        path: Verified_Backtest_Data/phase3_batch_batch9_analysis.json
  
  analyze-batch-10:
    needs: prepare-batches
    if: ${{ github.event.inputs.mode == 'full' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install enhanced dependencies
      run: |
        pip install requests pandas numpy
        pip install beautifulsoup4 lxml
        pip install yfinance
        pip install pytrends
        pip install GoogleNews
    
    - name: Download batch files
      uses: actions/download-artifact@v4
      with:
        name: batch-inputs
        path: batch_inputs/
    
    - name: Analyze Batch 10
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "ðŸ”¬ Analyzing Batch 10 with ALL data collectors..."
        python phase3_comprehensive_collector.py batch10 batch_inputs/batch10_stocks.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: batch10-results
        path: Verified_Backtest_Data/phase3_batch_batch10_analysis.json
  
  # Merge all results
  merge-results:
    needs: [analyze-batch-1, analyze-batch-2, analyze-batch-3, analyze-batch-4, analyze-batch-5, analyze-batch-6, analyze-batch-7, analyze-batch-8, analyze-batch-9, analyze-batch-10]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Download all batch results
      uses: actions/download-artifact@v4
      with:
        pattern: batch*-results
        path: batch_results/
        merge-multiple: true
    
    - name: List downloaded results
      run: |
        echo "ðŸ“ Downloaded batch results:"
        ls -lh batch_results/
    
    - name: Merge batch results
      run: |
        echo "ðŸ”„ Merging all batch results..."
        python phase3_batch_merger_v2.py batch_results/
    
    - name: Generate correlation matrix
      run: |
        echo "ðŸ“Š Building correlation matrix with ALL data points..."
        python phase3_correlation_analyzer.py Verified_Backtest_Data/phase3_merged_analysis.json
    
    - name: Display results summary
      run: |
        echo "## ðŸ“Š Phase 3 Enhanced Analysis Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mode**: ${{ github.event.inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Results**: Check Verified_Backtest_Data/ folder for:" >> $GITHUB_STEP_SUMMARY
        echo "- phase3_merged_analysis.json" >> $GITHUB_STEP_SUMMARY
        echo "- phase3_correlation_matrix.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Analysis complete with 150+ data points per stock" >> $GITHUB_STEP_SUMMARY
    
    - name: Commit results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Phase 3 Enhanced Bot"
        
        # Add batch inputs and results
        git add batch_inputs/ 2>/dev/null || true
        git add Verified_Backtest_Data/phase3_*.json
        
        git diff --staged --quiet || git commit -m "ðŸ”¬ Phase 3 Enhanced Analysis: ${{ github.event.inputs.mode }} mode
        
        Analyzed stocks with ALL 150+ data points
        Mode: ${{ github.event.inputs.mode }}
        Date: $(date +'%Y-%m-%d %H:%M')"
        
        git pull origin main --rebase --autostash
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
