name: Phase 3 Parallel Analysis - Complete Fixed

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Analysis mode'
        required: true
        default: 'test'
        type: choice
        options:
          - test       # 10 stocks (5 batches × 2 stocks)
          - sample     # 100 stocks (5 batches × 20 stocks)
          - full       # All 694 stocks (10 batches × ~70 stocks)

permissions:
  contents: write

jobs:
  prepare-batches:
    runs-on: ubuntu-latest
    outputs:
      batch_count: ${{ steps.split.outputs.batch_count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Split stocks into batches
      id: split
      run: |
        python << 'EOF'
        import json
        import os
        
        # Load explosive stocks
        with open('Verified_Backtest_Data/explosive_stocks_CLEAN.json', 'r') as f:
            all_stocks = json.load(f)
        
        mode = "${{ github.event.inputs.mode }}"
        
        if mode == "test":
            stocks = all_stocks[:10]
            batch_count = 5
            print(f"TEST MODE: {len(stocks)} stocks in {batch_count} batches")
        elif mode == "sample":
            stocks = all_stocks[:100]
            batch_count = 5
            print(f"SAMPLE MODE: {len(stocks)} stocks in {batch_count} batches")
        else:  # full
            stocks = all_stocks
            batch_count = 10
            print(f"FULL MODE: {len(stocks)} stocks in {batch_count} batches")
        
        # Create batch_inputs direc
