name: 4. Run Hybrid Model Full Backtest

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Run unit tests (placeholder)
        run: |
          echo "Running unit tests..."
          echo "Tests passed."

  run-parallel-backtest:
    needs: build-and-test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        batch_num: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39]

    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Calculate batch range and run backtest
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          export BATCH_START=$((250 * ${{ matrix.batch_num }}))
          export BATCH_END=$((250 * (${{ matrix.batch_num }} + 1)))
          echo "Running batch ${{ matrix.batch_num }}: $BATCH_START to $BATCH_END"
          python hybrid_model_backtester.py

      - name: 5. Upload Batch Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-artifacts-${{ matrix.batch_num }}
          path: |
            backtest_report_*.txt
            buy_signals_*.json
          retention-days: 7

  collect-reports:
    needs: run-parallel-backtest
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Download all batch artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          pattern: backtest-artifacts-*
          merge-multiple: true

      - name: 5. Run Collection Script
        run: python collect_reports.py

      - name: 6. Upload Final Master Report
        uses: actions/upload-artifact@v4
        with:
          name: FINAL-Backtest-Report
          path: |
            FINAL_backtest_report.txt
            FINAL_buy_signals.json
          retention-days: 30
