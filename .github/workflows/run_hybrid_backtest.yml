name: 4. Run Hybrid Model Full Backtest

on:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Run unit tests (placeholder)
        run: |
          echo "Running unit tests..."
          # Add test commands here, e.g., pytest
          echo "Tests passed."

  run-parallel-backtest:
    needs: build-and-test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 40 jobs, 250 tickers each = 10,000 tickers
        batch_start: [0, 250, 500, 750, 1000, 1250, 1500, 1750, 2000, 2250, 2500, 2750, 3000, 3250, 3500, 3750, 4000, 4250, 4500, 4750, 5000, 5250, 5500, 5750, 6000, 6250, 6500, 6750, 7000, 7250, 7500, 7750, 8000, 8250, 8500, 8750, 9000, 9250, 9500, 9750]
        batch_end: [250, 500, 750, 1000, 1250, 1500, 1750, 2000, 2250, 2500, 2750, 3000, 3250, 3500, 3750, 4000, 4250, 4500, 4750, 5000, 5250, 5500, 5750, 6000, 6250, 6500, 6750, 7000, 7250, 7500, 7750, 8000, 8250, 8500, 8750, 9000, 9250, 9500, 9750, 10000]

    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Run Optimized Backtest Batch
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          BATCH_START: ${{ matrix.batch_start }}
          BATCH_END: ${{ matrix.batch_end }}
        run: python hybrid_model_backtester.py

      - name: 5. Upload Batch Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-artifacts-${{ matrix.batch_start }}
          path: |
            backtest_report_*.txt
            buy_signals_*.json
          retention-days: 7

  collect-reports:
    needs: run-parallel-backtest
    runs-on: ubuntu-latest
    if: success() # Only run if all parallel jobs succeed
    steps:
      - name: 1. Check out repository code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. Install dependencies
        run: pip install -r requirements.txt

      - name: 4. Download all batch artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts
          pattern: backtest-artifacts-* # Download all artifacts starting with this prefix
          merge-multiple: true # Merges all downloaded artifacts into the 'all_artifacts' directory

      - name: 5. Run Collection Script
        run: python collect_reports.py

      - name: 6. Upload Final Master Report
        uses: actions/upload-artifact@v4
        with:
          name: FINAL-Backtest-Report
          path: |
            FINAL_backtest_report.txt
            FINAL_buy_signals.json
          retention-days: 30
