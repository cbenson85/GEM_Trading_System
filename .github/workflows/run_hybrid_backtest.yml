name: Run Hybrid Model Backtest (2-Year)

on:
  workflow_dispatch:
    inputs:
      scan_start:
        description: 'Start date (YYYY-MM-DD)'
        required: true
        default: '2022-01-01'
      scan_end:
        description: 'End date (YYYY-MM-DD)'
        required: true
        default: '2023-12-31'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 720 # 12-hour timeout for the full run
    permissions:
      contents: write # Allow the job to push the final report

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 3. Install All Dependencies
        run: |
          pip install requests numpy polygon-api-client pandas

      - name: 4. Run Full Market Backtest
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          SCAN_START_DATE: ${{ github.event.inputs.scan_start }}
          SCAN_END_DATE: ${{ github.event.inputs.scan_end }}
        run: |
          echo "--- Starting Hybrid Backtest (Unlimited API Mode) ---"
          echo "Scanning from ${{ github.event.inputs.scan_start }} to ${{ github.event.inputs.scan_end }}"
          python hybrid_model_backtester.py

      - name: 5. Commit Final Report
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add HYBRID_BACKTEST_FINAL_REPORT.txt
          git status
          
          if git diff --cached --quiet; then
            echo "No changes to commit. Report was not generated or is identical."
            # We exit 0 here so the workflow doesn't fail if no signals were found
            exit 0
          fi
          
          git commit -m "Automated Workflow: Run 2-Year Hybrid Backtest (${{ github.event.inputs.scan_start }} to ${{ github.event.inputs.scan_end }}) - $(date)"
          git push
