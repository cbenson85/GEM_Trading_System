name: Prepare for Phase 3

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for preparation'
        required: false
        default: 'Organize filtered stocks for Phase 3 pattern discovery'

jobs:
  prepare-phase3:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Pre-Preparation Status
        run: |
          echo "================================================"
          echo "PRE-PREPARATION STATUS"
          echo "================================================"
          echo ""
          echo "Current CLEAN.json:"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', data) if isinstance(data, dict) else data
          print(f'  Total stocks: {len(stocks)}')
          
          # Count by test status
          sustainable = 0
          not_tested = 0
          for stock in stocks:
              test = stock.get('sustained_gain_test', {})
              if not test or test.get('sustainable') is None:
                  not_tested += 1
              elif test.get('sustainable'):
                  sustainable += 1
          
          print(f'  Verified sustainable: {sustainable}')
          print(f'  Not tested: {not_tested}')
          "
          echo ""
          echo "This script will:"
          echo "  1. Keep 72 verified sustainable stocks in CLEAN.json"
          echo "  2. Move 113 untested stocks to NOT_TESTED.json"
          echo "  3. Remove bulky daily_gains arrays (~90% size reduction)"
          echo "  4. Create backup with full data"
          echo ""
      
      - name: Run Phase 3 Preparation
        run: |
          echo "================================================"
          echo "RUNNING PHASE 3 PREPARATION"
          echo "================================================"
          echo ""
          python prepare_phase3.py
        env:
          PYTHONUNBUFFERED: 1
      
      - name: Verify Results
        run: |
          echo ""
          echo "================================================"
          echo "VERIFICATION"
          echo "================================================"
          echo ""
          echo "‚úÖ CLEAN.json (Sustainable - Phase 3 Ready):"
          python -c "
          import json
          data = json.load(open('Verified_Backtest_Data/explosive_stocks_CLEAN.json'))
          stocks = data.get('stocks', [])
          print(f'  Total: {len(stocks)} verified sustainable stocks')
          "
          echo ""
          echo "‚ö†Ô∏è  NOT_TESTED.json (Missing Data):"
          python -c "
          import json
          try:
              data = json.load(open('Verified_Backtest_Data/explosive_stocks_NOT_TESTED.json'))
              stocks = data.get('stocks', [])
              print(f'  Total: {len(stocks)} stocks without test data')
          except:
              print('  File not found')
          "
          echo ""
          echo "‚ùå UNSUSTAINABLE.json (Pump & Dumps):"
          python -c "
          import json
          try:
              data = json.load(open('Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json'))
              count = len(data) if isinstance(data, list) else len(data.get('stocks', []))
              print(f'  Total: {count} pump-and-dump stocks')
          except:
              print('  File not found')
          "
          echo ""
          echo "üìä Summary:"
          cat Verified_Backtest_Data/phase3_preparation_summary.json | python -m json.tool
          echo ""
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all modified files
          git add Verified_Backtest_Data/explosive_stocks_CLEAN.json
          git add Verified_Backtest_Data/explosive_stocks_NOT_TESTED.json
          git add Verified_Backtest_Data/explosive_stocks_CLEAN_FULL_BACKUP.json
          git add Verified_Backtest_Data/phase3_preparation_summary.json
          
          # Commit
          git diff --staged --quiet || git commit -m "üéØ Phase 3 Preparation Complete
          
          Organized filtered stocks for pattern discovery:
          - CLEAN.json: 72 verified sustainable stocks (ready for Phase 3)
          - NOT_TESTED.json: 113 stocks without test data
          - UNSUSTAINABLE.json: 15 pump-and-dumps (already filtered)
          - Removed bulky daily_gains arrays (~90% size reduction)
          - Created full backup before cleanup
          
          Status: READY FOR PHASE 3 PATTERN DISCOVERY ‚úÖ
          Reason: ${{ github.event.inputs.reason }}"
          
          # Push
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "‚úÖ PHASE 3 PREPARATION COMPLETE"
          echo "================================================"
          echo ""
          echo "Files Ready:"
          echo "  ‚Ä¢ explosive_stocks_CLEAN.json (72 stocks - USE THIS)"
          echo "  ‚Ä¢ explosive_stocks_NOT_TESTED.json (113 stocks - reference)"
          echo "  ‚Ä¢ explosive_stocks_UNSUSTAINABLE.json (15 stocks - reference)"
          echo ""
          echo "Next Steps:"
          echo "  1. Review CLEAN.json (72 verified sustainable stocks)"
          echo "  2. Begin Phase 3 pattern discovery:"
          echo "     - Sector analysis"
          echo "     - Technical patterns"
          echo "     - Catalyst timing"
          echo "     - Volume characteristics"
          echo "  3. Build screening criteria from patterns"
          echo "  4. Create GEM v6 screener"
          echo ""
          echo "üéØ YOU'RE NOW READY FOR PHASE 3!"
          echo "================================================"
          echo ""
