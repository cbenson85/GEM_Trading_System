name: Test Live Screener Model

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: 'Input file to test screener against'
        required: true
        default: 'DISCARD_EXPLOSIONS.json'

jobs:
  test-screener:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allow the job to push the new report

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 3. Install All Dependencies
        run: |
          echo "Installing all required libraries..."
          pip install requests numpy polygon-api-client pandas

      - name: 4. Run Screener in Test Mode
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          INPUT_FILE=${{ github.event.inputs.input_file }}
          
          echo "Running live_screener.py in test mode on $INPUT_FILE..."
          if [ ! -f "$INPUT_FILE" ]; then
            echo "‚ùå CRITICAL ERROR: Input file '$INPUT_FILE' not found!"
            exit 1
          fi
          
          # Pass the input file as an argument to the screener
          python live_screener.py "$INPUT_FILE"
          
          echo "Screener test complete. Report saved to screener_test_report.txt"

      - name: 5. Commit and push test report
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add screener_test_report.txt
          git status
          
          if git diff --cached --quiet; then
            echo "No changes to commit. Report is identical to the previous run."
            exit 0
          fi
          
          git commit -m "Automated Workflow: Run screener test and save report - $(date)"
          git push
