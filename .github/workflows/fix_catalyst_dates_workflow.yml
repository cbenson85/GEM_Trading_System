name: Fix Catalyst Dates

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-catalyst-dates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Check input file exists
      run: |
        echo "üìÅ Checking for input file..."
        if [ -f "Verified_Backtest_Data/explosive_stocks_CLEAN.json" ]; then
          echo "‚úÖ Found explosive_stocks_CLEAN.json"
          echo "File size: $(wc -c < Verified_Backtest_Data/explosive_stocks_CLEAN.json) bytes"
          echo ""
          echo "First 500 characters:"
          head -c 500 Verified_Backtest_Data/explosive_stocks_CLEAN.json
        else
          echo "‚ùå explosive_stocks_CLEAN.json NOT FOUND!"
          ls -la Verified_Backtest_Data/
        fi
    
    - name: Test Polygon API key
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "Testing Polygon API connection..."
        python -c "
        import os
        import requests
        
        key = os.environ.get('POLYGON_API_KEY')
        if not key:
            print('‚ùå No API key found!')
        else:
            print(f'‚úÖ API key found: {key[:10]}...')
            
            # Test API call
            url = 'https://api.polygon.io/v2/aggs/ticker/AAPL/range/1/day/2024-01-01/2024-01-10'
            params = {'apiKey': key}
            
            try:
                response = requests.get(url, params=params)
                if response.status_code == 200:
                    print('‚úÖ API test successful!')
                else:
                    print(f'‚ùå API error: {response.status_code}')
                    print(response.text[:500])
            except Exception as e:
                print(f'‚ùå Connection error: {e}')
        "
    
    - name: Find and fix catalyst dates
      env:
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
      run: |
        echo "Running catalyst date finder..."
        python find_real_catalyst_dates.py || echo "Script failed with exit code $?"
    
    - name: Check for output
      run: |
        echo "üìÅ Checking for output files..."
        ls -la Verified_Backtest_Data/*.json
        
        if [ -f "Verified_Backtest_Data/explosive_stocks_CATALYST_FIXED.json" ]; then
          echo "‚úÖ Output file created!"
          echo "File size: $(wc -c < Verified_Backtest_Data/explosive_stocks_CATALYST_FIXED.json) bytes"
        else
          echo "‚ùå No output file created"
        fi
    
    - name: Commit if successful
      run: |
        if [ -f "Verified_Backtest_Data/explosive_stocks_CATALYST_FIXED.json" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "Catalyst Fix Bot"
          
          git add Verified_Backtest_Data/*.json
          git add find_real_catalyst_dates.py
          
          git diff --staged --quiet || git commit -m "üéØ Fixed catalyst dates"
          git push
        else
          echo "No files to commit"
        fi
