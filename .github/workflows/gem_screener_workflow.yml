name: GEM Screener v6.0 - Daily Screen (Simplified)

on:
  workflow_dispatch:
    inputs:
      stock_universe:
        description: 'Stock universe size'
        required: true
        default: 'small'
        type: choice
        options:
          - small
          - medium
          - large
          - custom
      custom_tickers:
        description: 'Custom tickers (comma separated)'
        required: false
        default: ''
  schedule:
    # Run every weekday at 4:30 PM ET
    - cron: '30 21 * * 1-5'

jobs:
  screen:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install yfinance pandas numpy requests
        pip install --upgrade setuptools wheel
    
    - name: Create stock universe
      run: |
        mkdir -p Daily_Screens
        
        # Create universe based on input
        if [ "${{ inputs.stock_universe }}" == "custom" ] && [ -n "${{ inputs.custom_tickers }}" ]; then
          echo "${{ inputs.custom_tickers }}" | tr ',' '\n' > stock_universe.txt
        else
          # Default small universe
          cat > stock_universe.txt << 'EOF'
        PLTR
        SOFI
        RIVN
        LCID
        NIO
        BBIG
        PROG
        ATER
        VERU
        IMPP
        MULN
        HYMC
        XELA
        CEI
        INDO
        BBAI
        APRN
        ALLK
        COSM
        SNDL
        EOF
        fi
        
        echo "Stock universe:"
        cat stock_universe.txt
    
    - name: Run screener
      run: |
        python3 << 'PYTHON_EOF'
        import sys
        import json
        import yfinance as yf
        import pandas as pd
        import numpy as np
        from datetime import datetime
        import warnings
        warnings.filterwarnings('ignore')
        
        # Simplified screener for workflow
        class SimpleGEMScreener:
            def __init__(self):
                self.weights = {
                    'volume_3x': 25,
                    'volume_5x': 35,
                    'volume_10x': 50,
                    'rsi_oversold_35': 20,
                    'rsi_oversold_30': 30,
                    'accumulation': 40,
                    'market_outperform': 15
                }
            
            def analyze_stock(self, ticker):
                try:
                    stock = yf.Ticker(ticker)
                    df = stock.history(period="3mo")
                    
                    if len(df) < 20:
                        return None
                    
                    # Basic calculations
                    current_price = df['Close'].iloc[-1]
                    current_volume = df['Volume'].iloc[-1]
                    avg_volume = df['Volume'].iloc[-20:].mean()
                    
                    # Volume spike
                    volume_spike = current_volume / avg_volume if avg_volume > 0 else 0
                    
                    # RSI
                    delta = df['Close'].diff()
                    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
                    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
                    rs = gain / loss
                    rsi = 100 - (100 / (1 + rs))
                    current_rsi = rsi.iloc[-1]
                    
                    # Score calculation
                    score = 0
                    patterns = []
                    
                    if volume_spike >= 10:
                        score += self.weights['volume_10x']
                        patterns.append('volume_10x')
                    elif volume_spike >= 5:
                        score += self.weights['volume_5x']
                        patterns.append('volume_5x')
                    elif volume_spike >= 3:
                        score += self.weights['volume_3x']
                        patterns.append('volume_3x')
                    
                    if current_rsi < 30:
                        score += self.weights['rsi_oversold_30']
                        patterns.append('rsi_30')
                    elif current_rsi < 35:
                        score += self.weights['rsi_oversold_35']
                        patterns.append('rsi_35')
                    
                    return {
                        'ticker': ticker,
                        'score': score,
                        'price': round(current_price, 2),
                        'volume_spike': round(volume_spike, 1),
                        'rsi': round(current_rsi, 1),
                        'patterns': patterns,
                        'recommendation': 'STRONG BUY' if score >= 100 else 'BUY' if score >= 75 else 'WATCH' if score >= 60 else 'PASS'
                    }
                    
                except Exception as e:
                    print(f"Error analyzing {ticker}: {e}")
                    return None
        
        # Main execution
        print("="*60)
        print(f"GEM Screener v6.0 - {datetime.now()}")
        print("="*60)
        
        # Read stock universe
        with open('stock_universe.txt', 'r') as f:
            stocks = [line.strip() for line in f if line.strip()]
        
        print(f"Screening {len(stocks)} stocks...")
        
        # Run screener
        screener = SimpleGEMScreener()
        results = []
        
        for ticker in stocks:
            result = screener.analyze_stock(ticker)
            if result and result['price'] >= 0.50 and result['price'] <= 15.00:
                results.append(result)
        
        # Sort by score
        results = sorted(results, key=lambda x: x['score'], reverse=True)
        
        # Display top 30
        print("\nTOP 30 RESULTS:")
        print("-"*60)
        for i, r in enumerate(results[:30], 1):
            print(f"{i}. {r['ticker']}: Score {r['score']} - {r['recommendation']}")
            print(f"   Price: ${r['price']}, Volume: {r['volume_spike']}x, RSI: {r['rsi']}")
        
        # Save results
        output = {
            'screen_date': datetime.now().isoformat(),
            'total_screened': len(stocks),
            'passed_filters': len(results),
            'results': {
                'all_results': results,
                'top_30': results[:30],
                'strong_buys': [r for r in results if r['score'] >= 100]
            }
        }
        
        with open('Daily_Screens/latest_screen.json', 'w') as f:
            json.dump(output, f, indent=2)
        
        # Create markdown report
        with open('Daily_Screens/latest_screen.md', 'w') as f:
            f.write(f"# GEM Screener Results - {datetime.now()}\n\n")
            f.write("## Top 30 Stocks\n\n")
            f.write("| Rank | Ticker | Score | Rec | Price | Vol Spike | RSI |\n")
            f.write("|------|--------|-------|-----|-------|-----------|-----|\n")
            for i, r in enumerate(results[:30], 1):
                f.write(f"| {i} | {r['ticker']} | {r['score']} | {r['recommendation']} | ${r['price']} | {r['volume_spike']}x | {r['rsi']} |\n")
        
        # Check for strong buys
        strong_buys = [r for r in results if r['score'] >= 100]
        if strong_buys:
            print(f"\nðŸš¨ STRONG BUY ALERTS: {len(strong_buys)} stocks with score 100+")
            with open('strong_buy_alert.txt', 'w') as f:
                f.write("STRONG_BUYS_FOUND=true\n")
                f.write(f"COUNT={len(strong_buys)}\n")
        
        print(f"\nâœ… Results saved to Daily_Screens/")
        PYTHON_EOF
    
    - name: Check for alerts
      id: check_alerts
      run: |
        if [ -f "strong_buy_alert.txt" ]; then
          cat strong_buy_alert.txt >> $GITHUB_ENV
          echo "Strong buy signals detected!"
        fi
    
    - name: Commit results
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add Daily_Screens/ || true
        git diff --staged --quiet || git commit -m "Screen results - $(date +'%Y-%m-%d %H:%M')"
        git push || echo "No changes to push"
    
    - name: Create issue for strong buys
      if: env.STRONG_BUYS_FOUND == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('Daily_Screens/latest_screen.json', 'utf8'));
          const strongBuys = data.results.strong_buys.slice(0, 5);
          
          let body = '# ðŸš¨ Strong Buy Signals Detected\n\n';
          body += 'The following stocks have scores of 100+:\n\n';
          
          strongBuys.forEach(stock => {
            body += `- **${stock.ticker}**: Score ${stock.score}\n`;
            body += `  - Price: $${stock.price}\n`;
            body += `  - Volume Spike: ${stock.volume_spike}x\n`;
            body += `  - RSI: ${stock.rsi}\n\n`;
          });
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Strong Buy Alert - ${new Date().toLocaleDateString()}`,
            body: body,
            labels: ['trading-signal', 'strong-buy']
          });
