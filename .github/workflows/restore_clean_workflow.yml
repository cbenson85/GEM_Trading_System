name: Restore CLEAN.json from UNSUSTAINABLE

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "RESTORE" to confirm restoration'
        required: true
        default: ''

jobs:
  restore-clean:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESTORE" ]; then
            echo "‚ùå Restoration not confirmed. You must type 'RESTORE' to proceed."
            exit 1
          fi
          echo "‚úÖ Restoration confirmed. Proceeding..."
      
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Verify Files Exist
        run: |
          echo "üìÇ Checking for required files..."
          if [ ! -f "Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json" ]; then
            echo "‚ùå ERROR: UNSUSTAINABLE.json not found!"
            exit 1
          fi
          echo "‚úÖ All required files found"
      
      - name: Backup Current Files
        run: |
          echo "üíæ Creating backups..."
          mkdir -p Verified_Backtest_Data/backups
          if [ -f "Verified_Backtest_Data/explosive_stocks_CLEAN.json" ]; then
            cp Verified_Backtest_Data/explosive_stocks_CLEAN.json Verified_Backtest_Data/backups/CLEAN_before_restore.json
          fi
          cp Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json Verified_Backtest_Data/backups/UNSUSTAINABLE_backup.json
          if [ -f "Verified_Backtest_Data/sustainability_summary.json" ]; then
            cp Verified_Backtest_Data/sustainability_summary.json Verified_Backtest_Data/backups/sustainability_summary_backup.json
          fi
          echo "‚úÖ Backups created"
      
      - name: Restore CLEAN.json
        run: |
          python3 << 'EOF'
          import json
          
          print("="*70)
          print("üîÑ RESTORING CLEAN.JSON")
          print("="*70)
          
          # Load all stocks from UNSUSTAINABLE.json
          with open('Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json', 'r') as f:
              all_stocks = json.load(f)
          
          print(f"\n‚úÖ Loaded {len(all_stocks)} stocks")
          
          # Remove test fields
          restored_stocks = []
          for stock in all_stocks:
              clean_stock = {k: v for k, v in stock.items() 
                            if k not in ['sustainability_test', 'tested_date']}
              restored_stocks.append(clean_stock)
          
          # Create restored structure
          restored_clean = {
              "scan_info": {
                  "scan_date": "2025-11-01",
                  "scan_period_start": "2014-01-01",
                  "scan_period_end": "2024-12-31",
                  "criteria": "500%+ gain in any 180-day window",
                  "data_sources": ["Polygon API", "Yahoo Finance"],
                  "total_stocks_scanned": 11000,
                  "total_explosive_stocks_found": 244,
                  "data_errors": 5043,
                  "api_calls_made": 11066,
                  "scan_complete": True,
                  "scan_method": "GitHub Actions - Full 10-year historical scan"
              },
              "filter_info": {
                  "filter_date": "2025-11-01",
                  "filter_applied": "COVID-era exclusion (2020-2021)",
                  "original_count": 239,
                  "clean_count": 200,
                  "excluded_count": 69
              },
              "stocks": restored_stocks,
              "metadata": {
                  "note": "Pattern analysis dataset - normal market conditions only"
              }
          }
          
          # Save
          with open('Verified_Backtest_Data/explosive_stocks_CLEAN.json', 'w') as f:
              json.dump(restored_clean, f, indent=2)
          
          print(f"‚úÖ Restored {len(restored_stocks)} stocks to CLEAN.json")
          print("="*70)
          EOF
      
      - name: Remove Failed Filter Results
        run: |
          echo "üóëÔ∏è Removing failed filter results..."
          rm -f Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json
          rm -f Verified_Backtest_Data/sustainability_summary.json
          echo "‚úÖ Removed filter files"
      
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Verified_Backtest_Data/explosive_stocks_CLEAN.json
          git add Verified_Backtest_Data/backups/
          git rm -f Verified_Backtest_Data/explosive_stocks_UNSUSTAINABLE.json 2>/dev/null || true
          git rm -f Verified_Backtest_Data/sustainability_summary.json 2>/dev/null || true
          git commit -m "üîÑ Restore CLEAN.json - Remove failed sustainability filter"
          git push
