name: Run Backtest on Master Data

on:
  workflow_dispatch: # Allows you to run this manually from the "Actions" tab

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Allow the job to push the new report

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: 2. Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 3. Install Analysis Dependencies
        run: |
          echo "Installing libraries for analysis..."
          pip install pandas numpy

      - name: 4. Run Backtester Script
        run: |
          echo "Running backtest on MASTER_FINGERPRINTS.json..."
          if [ ! -f "MASTER_FINGERPRINTS.json" ]; then
            echo "‚ùå CRITICAL ERROR: MASTER_FINGERPRINTS.json not found!"
            echo "Please run the 'Full Data Pipeline' workflow first to generate it."
            exit 1
          fi
          python backtester.py
          echo "Backtest complete. Report saved to backtest_report.txt"

      - name: 5. Commit and push report
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add the new report file and the updated clean file
          git add backtest_report.txt
          git add CLEAN_FINGERPRINTS_FOR_BACKTEST.json
          git status
          
          if git diff --cached --quiet; then
            echo "No changes to commit. Report is identical to the previous run."
            exit 0
          fi
          
          git commit -m "Automated Workflow: Run backtest and save report - $(date)"
          git push
